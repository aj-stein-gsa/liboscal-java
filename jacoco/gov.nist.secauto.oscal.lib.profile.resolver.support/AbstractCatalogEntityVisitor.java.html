<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AbstractCatalogEntityVisitor.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">OSCAL Java Library</a> &gt; <a href="index.source.html" class="el_package">gov.nist.secauto.oscal.lib.profile.resolver.support</a> &gt; <span class="el_source">AbstractCatalogEntityVisitor.java</span></div><h1>AbstractCatalogEntityVisitor.java</h1><pre class="source lang-java linenums">/*
 * SPDX-FileCopyrightText: none
 * SPDX-License-Identifier: CC0-1.0
 */

package gov.nist.secauto.oscal.lib.profile.resolver.support;

import gov.nist.secauto.metaschema.core.metapath.MetapathExpression;
import gov.nist.secauto.metaschema.core.metapath.item.node.IAssemblyNodeItem;
import gov.nist.secauto.metaschema.core.metapath.item.node.IDocumentNodeItem;
import gov.nist.secauto.metaschema.core.metapath.item.node.IRootAssemblyNodeItem;
import gov.nist.secauto.metaschema.core.util.CollectionUtil;
import gov.nist.secauto.metaschema.core.util.ObjectUtils;
import gov.nist.secauto.oscal.lib.OscalBindingContext;
import gov.nist.secauto.oscal.lib.OscalModelConstants;

import java.util.Collections;
import java.util.EnumSet;
import java.util.Set;

import edu.umd.cs.findbugs.annotations.NonNull;

/**
 * Visits a catalog document and its children as designated.
 * &lt;p&gt;
 * This implementation is stateless. The {@code T} parameter can be used to
 * convey state as needed.
 *
 * @param &lt;T&gt;
 *          the state type
 * @param &lt;R&gt;
 *          the result type
 */
public abstract class AbstractCatalogEntityVisitor&lt;T, R&gt;
    extends AbstractCatalogVisitor&lt;T, R&gt; {
  @NonNull
<span class="fc" id="L37">  public static final MetapathExpression CHILD_PART_METAPATH</span>
<span class="fc" id="L38">      = MetapathExpression.compile(&quot;part|part//part&quot;,</span>
          OscalBindingContext.OSCAL_STATIC_METAPATH_CONTEXT);
  @NonNull
<span class="fc" id="L41">  private static final MetapathExpression BACK_MATTER_RESOURCES_METAPATH</span>
<span class="fc" id="L42">      = MetapathExpression.compile(&quot;back-matter/resource&quot;,</span>
          OscalBindingContext.OSCAL_STATIC_METAPATH_CONTEXT);
  @NonNull
<span class="fc" id="L45">  private static final Set&lt;IEntityItem.ItemType&gt; GROUP_CONTAINER_TYPES</span>
<span class="fc" id="L46">      = ObjectUtils.notNull(EnumSet.of(</span>
          IEntityItem.ItemType.GROUP,
          IEntityItem.ItemType.CONTROL,
          IEntityItem.ItemType.PARAMETER,
          IEntityItem.ItemType.PART));
  @NonNull
<span class="fc" id="L52">  private static final Set&lt;IEntityItem.ItemType&gt; CONTROL_CONTAINER_TYPES</span>
<span class="fc" id="L53">      = ObjectUtils.notNull(EnumSet.of(</span>
          IEntityItem.ItemType.CONTROL,
          IEntityItem.ItemType.PARAMETER,
          IEntityItem.ItemType.PART));
  @NonNull
  private final Set&lt;IEntityItem.ItemType&gt; itemTypesToVisit;

  /**
   * Create a new visitor that will visit the item types identified by
   * {@code itemTypesToVisit}.
   *
   * @param itemTypesToVisit
   *          the item type the visitor will visit
   */
<span class="fc" id="L67">  public AbstractCatalogEntityVisitor(@NonNull Set&lt;IEntityItem.ItemType&gt; itemTypesToVisit) {</span>
<span class="fc" id="L68">    this.itemTypesToVisit = CollectionUtil.unmodifiableSet(itemTypesToVisit);</span>
<span class="fc" id="L69">  }</span>

  public Set&lt;IEntityItem.ItemType&gt; getItemTypesToVisit() {
<span class="fc" id="L72">    return CollectionUtil.unmodifiableSet(itemTypesToVisit);</span>
  }

  protected boolean isVisitedItemType(@NonNull IEntityItem.ItemType type) {
<span class="fc" id="L76">    return itemTypesToVisit.contains(type);</span>
  }

  @Override
  public R visitCatalog(IDocumentNodeItem catalogDocument, T state) {
<span class="fc" id="L81">    R result = super.visitCatalog(catalogDocument, state);</span>

<span class="fc" id="L83">    catalogDocument.modelItems().forEachOrdered(item -&gt; {</span>
<span class="fc" id="L84">      IRootAssemblyNodeItem root = ObjectUtils.requireNonNull((IRootAssemblyNodeItem) item);</span>
<span class="fc" id="L85">      visitMetadata(root, state);</span>
<span class="fc" id="L86">      visitBackMatter(root, state);</span>
<span class="fc" id="L87">    });</span>
<span class="fc" id="L88">    return result;</span>
  }

  @Override
  protected R visitGroupContainer(IAssemblyNodeItem catalogOrGroup, R initialResult, T state) {
    R retval;
<span class="pc bpc" id="L94" title="1 of 2 branches missed.">    if (Collections.disjoint(getItemTypesToVisit(), GROUP_CONTAINER_TYPES)) {</span>
<span class="nc" id="L95">      retval = initialResult;</span>
    } else {
<span class="fc" id="L97">      retval = super.visitGroupContainer(catalogOrGroup, initialResult, state);</span>
    }
<span class="fc" id="L99">    return retval;</span>
  }

  @Override
  protected R visitControlContainer(IAssemblyNodeItem catalogOrGroupOrControl, R initialResult, T state) {
    R retval;
<span class="pc bpc" id="L105" title="1 of 2 branches missed.">    if (Collections.disjoint(getItemTypesToVisit(), CONTROL_CONTAINER_TYPES)) {</span>
<span class="nc" id="L106">      retval = initialResult;</span>
    } else {
      // first descend to all control container children
<span class="fc" id="L109">      retval = super.visitControlContainer(catalogOrGroupOrControl, initialResult, state);</span>

      // handle parameters
<span class="fc bfc" id="L112" title="All 2 branches covered.">      if (isVisitedItemType(IEntityItem.ItemType.PARAMETER)) {</span>
<span class="fc" id="L113">        retval = catalogOrGroupOrControl.getModelItemsByName(OscalModelConstants.QNAME_PARAM).stream()</span>
<span class="fc" id="L114">            .map(paramItem -&gt; visitParameter(</span>
<span class="fc" id="L115">                ObjectUtils.requireNonNull((IAssemblyNodeItem) paramItem),</span>
                catalogOrGroupOrControl,
                state))
<span class="fc" id="L118">            .reduce(retval, (first, second) -&gt; aggregateResults(first, second, state));</span>
      }
    }
<span class="fc" id="L121">    return retval;</span>
  }

  protected void visitParts(@NonNull IAssemblyNodeItem groupOrControlItem, T state) {
    // handle parts
<span class="pc bpc" id="L126" title="1 of 2 branches missed.">    if (isVisitedItemType(IEntityItem.ItemType.PART)) {</span>
<span class="fc" id="L127">      CHILD_PART_METAPATH.evaluate(groupOrControlItem).stream()</span>
<span class="fc" id="L128">          .map(item -&gt; (IAssemblyNodeItem) item)</span>
<span class="fc" id="L129">          .forEachOrdered(partItem -&gt; {</span>
<span class="fc" id="L130">            visitPart(ObjectUtils.requireNonNull(partItem), groupOrControlItem, state);</span>
<span class="fc" id="L131">          });</span>
    }
<span class="fc" id="L133">  }</span>

  @Override
  protected R visitGroupInternal(@NonNull IAssemblyNodeItem item, R childResult, T state) {
<span class="fc bfc" id="L137" title="All 2 branches covered.">    if (isVisitedItemType(IEntityItem.ItemType.PART)) {</span>
<span class="fc" id="L138">      visitParts(item, state);</span>
    }

<span class="fc" id="L141">    R retval = childResult;</span>
<span class="fc bfc" id="L142" title="All 2 branches covered.">    if (isVisitedItemType(IEntityItem.ItemType.GROUP)) {</span>
<span class="fc" id="L143">      retval = visitGroup(item, retval, state);</span>
    }
<span class="fc" id="L145">    return retval;</span>
  }

  @Override
  protected R visitControlInternal(IAssemblyNodeItem item, R childResult, T state) {
<span class="fc bfc" id="L150" title="All 2 branches covered.">    if (isVisitedItemType(IEntityItem.ItemType.PART)) {</span>
<span class="fc" id="L151">      visitParts(item, state);</span>
    }

<span class="fc" id="L154">    R retval = childResult;</span>
<span class="pc bpc" id="L155" title="1 of 2 branches missed.">    if (isVisitedItemType(IEntityItem.ItemType.CONTROL)) {</span>
<span class="fc" id="L156">      retval = visitControl(item, retval, state);</span>
    }
<span class="fc" id="L158">    return retval;</span>
  }

  /**
   * Called when visiting a parameter.
   * &lt;p&gt;
   * Can be overridden by classes extending this interface to support processing
   * of the visited object.
   *
   * @param item
   *          the Metapath item for the parameter
   * @param catalogOrGroupOrControl
   *          the parameter's parent Metapath item
   * @param state
   *          the calling context information
   * @return a meaningful result of the given type
   */
  protected R visitParameter(
      @NonNull IAssemblyNodeItem item,
      @NonNull IAssemblyNodeItem catalogOrGroupOrControl,
      T state) {
    // do nothing
<span class="nc" id="L180">    return newDefaultResult(state);</span>
  }

  /**
   * Called when visiting a part.
   * &lt;p&gt;
   * Can be overridden by classes extending this interface to support processing
   * of the visited object.
   *
   * @param item
   *          the Metapath item for the part
   * @param groupOrControl
   *          the part's parent Metapath item
   * @param state
   *          the calling context information
   */
  protected void visitPart( // NOPMD noop default
      @NonNull IAssemblyNodeItem item,
      @NonNull IAssemblyNodeItem groupOrControl,
      T state) {
    // do nothing
<span class="nc" id="L201">  }</span>

  /**
   * Called when visiting the &quot;metadata&quot; section of an OSCAL document.
   * &lt;p&gt;
   * Visits each contained role, location, and party.
   *
   * @param rootItem
   *          the root Module node item containing the &quot;metadata&quot; node
   * @param state
   *          the calling context information
   */
  protected void visitMetadata(@NonNull IRootAssemblyNodeItem rootItem, T state) {
<span class="fc" id="L214">    rootItem.getModelItemsByName(OscalModelConstants.QNAME_METADATA).stream()</span>
<span class="fc" id="L215">        .map(metadataItem -&gt; (IAssemblyNodeItem) metadataItem)</span>
<span class="fc" id="L216">        .forEach(metadataItem -&gt; {</span>
<span class="fc bfc" id="L217" title="All 2 branches covered.">          if (isVisitedItemType(IEntityItem.ItemType.ROLE)) {</span>
<span class="fc" id="L218">            metadataItem.getModelItemsByName(OscalModelConstants.QNAME_ROLE).stream()</span>
<span class="pc" id="L219">                .map(roleItem -&gt; (IAssemblyNodeItem) roleItem)</span>
<span class="fc" id="L220">                .forEachOrdered(roleItem -&gt; {</span>
<span class="nc" id="L221">                  visitRole(ObjectUtils.requireNonNull(roleItem), metadataItem, state);</span>
<span class="nc" id="L222">                });</span>
          }

<span class="fc bfc" id="L225" title="All 2 branches covered.">          if (isVisitedItemType(IEntityItem.ItemType.LOCATION)) {</span>
<span class="fc" id="L226">            metadataItem.getModelItemsByName(OscalModelConstants.QNAME_LOCATION).stream()</span>
<span class="pc" id="L227">                .map(locationItem -&gt; (IAssemblyNodeItem) locationItem)</span>
<span class="fc" id="L228">                .forEachOrdered(locationItem -&gt; {</span>
<span class="nc" id="L229">                  visitLocation(ObjectUtils.requireNonNull(locationItem), metadataItem, state);</span>
<span class="nc" id="L230">                });</span>
          }

<span class="fc bfc" id="L233" title="All 2 branches covered.">          if (isVisitedItemType(IEntityItem.ItemType.PARTY)) {</span>
<span class="fc" id="L234">            metadataItem.getModelItemsByName(OscalModelConstants.QNAME_PARTY).stream()</span>
<span class="pc" id="L235">                .map(partyItem -&gt; (IAssemblyNodeItem) partyItem)</span>
<span class="fc" id="L236">                .forEachOrdered(partyItem -&gt; {</span>
<span class="nc" id="L237">                  visitParty(ObjectUtils.requireNonNull(partyItem), metadataItem, state);</span>
<span class="nc" id="L238">                });</span>
          }
<span class="fc" id="L240">        });</span>
<span class="fc" id="L241">  }</span>

  /**
   * Called when visiting a role in the &quot;metadata&quot; section of an OSCAL document.
   * &lt;p&gt;
   * Can be overridden by classes extending this interface to support processing
   * of the visited object.
   *
   * @param item
   *          the role Module node item which is a child of the &quot;metadata&quot; node
   * @param metadataItem
   *          the &quot;metadata&quot; Module node item containing the role
   * @param state
   *          the calling context information
   */
  protected void visitRole( // NOPMD noop default
      @NonNull IAssemblyNodeItem item,
      @NonNull IAssemblyNodeItem metadataItem,
      T state) {
    // do nothing
<span class="nc" id="L261">  }</span>

  /**
   * Called when visiting a location in the &quot;metadata&quot; section of an OSCAL
   * document.
   * &lt;p&gt;
   * Can be overridden by classes extending this interface to support processing
   * of the visited object.
   *
   * @param item
   *          the location Module node item which is a child of the &quot;metadata&quot;
   *          node
   * @param metadataItem
   *          the &quot;metadata&quot; Module node item containing the location
   * @param state
   *          the calling context information
   */
  protected void visitLocation( // NOPMD noop default
      @NonNull IAssemblyNodeItem item,
      @NonNull IAssemblyNodeItem metadataItem,
      T state) {
    // do nothing
<span class="nc" id="L283">  }</span>

  /**
   * Called when visiting a party in the &quot;metadata&quot; section of an OSCAL document.
   * &lt;p&gt;
   * Can be overridden by classes extending this interface to support processing
   * of the visited object.
   *
   * @param item
   *          the party Module node item which is a child of the &quot;metadata&quot; node
   * @param metadataItem
   *          the &quot;metadata&quot; Module node item containing the party
   * @param state
   *          the calling context information
   */
  protected void visitParty( // NOPMD noop default
      @NonNull IAssemblyNodeItem item,
      @NonNull IAssemblyNodeItem metadataItem,
      T state) {
    // do nothing
<span class="nc" id="L303">  }</span>

  /**
   * Called when visiting the &quot;back-matter&quot; section of an OSCAL document.
   * &lt;p&gt;
   * Visits each contained resource.
   *
   * @param rootItem
   *          the root Module node item containing the &quot;back-matter&quot; node
   * @param state
   *          the calling context information
   */
  protected void visitBackMatter(@NonNull IRootAssemblyNodeItem rootItem, T state) {
<span class="fc bfc" id="L316" title="All 2 branches covered.">    if (isVisitedItemType(IEntityItem.ItemType.RESOURCE)) {</span>
<span class="fc" id="L317">      BACK_MATTER_RESOURCES_METAPATH.evaluate(rootItem).stream()</span>
<span class="fc" id="L318">          .map(item -&gt; (IAssemblyNodeItem) item)</span>
<span class="fc" id="L319">          .forEachOrdered(resourceItem -&gt; {</span>
<span class="fc" id="L320">            visitResource(ObjectUtils.requireNonNull(resourceItem), rootItem, state);</span>
<span class="fc" id="L321">          });</span>
    }
<span class="fc" id="L323">  }</span>

  /**
   * Called when visiting a resource in the &quot;back-matter&quot; section of an OSCAL
   * document.
   * &lt;p&gt;
   * Can be overridden by classes extending this interface to support processing
   * of the visited object.
   *
   * @param resource
   *          the resource Module node item which is a child of the &quot;metadata&quot;
   *          node
   * @param backMatter
   *          the resource Module node item containing the party
   * @param state
   *          the calling context information
   */
  protected void visitResource( // NOPMD noop default
      @NonNull IAssemblyNodeItem resource,
      @NonNull IRootAssemblyNodeItem backMatter,
      T state) {
    // do nothing
<span class="nc" id="L345">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>